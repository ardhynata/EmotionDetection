<div id="poller"
     hx-get="/analyze-frame-html"
     hx-trigger="every {{.RefreshInterval}}s"
     hx-swap="outerHTML">
</div>

<script>
(async () => {
  try {
    if (typeof window.captureFrame !== 'function') {
      console.error('captureFrame not available');
      return;
    }

    const blob = await window.captureFrame();
    if (!blob) return;

    const form = new FormData();
    form.append('frame', blob, 'frame.jpg');
    const res = await fetch('/analyze-frame', { method: 'POST', body: form });
    if (!res.ok) return;

    const data = await res.json();
    const now = new Date().toLocaleTimeString();

    const tbody = document.getElementById('results-body');
    const tr = document.createElement('tr');

    // --- Handle "no face detected" case ---
    if (data.result && data.result === "no-face") {
      tr.innerHTML = `<td>${now}</td><td colspan="2" style="text-align:center;color:#999;">(muka tidak terdeteksi)</td>`;
      tr.classList.add("blink-red"); // subtle red pulse to indicate missing detection
      if (tbody) tbody.prepend(tr);
      setTimeout(() => tr.classList.remove("blink-red"), 2000);
      return;
    }

    // --- Normal case (with numeric happy/sad) ---
    if (!data || isNaN(data.happy) || isNaN(data.sad)) {
      console.warn('Invalid data received, skipping table update:', data);
      return;
    }

    const happy = (data.happy * 100).toFixed(2);
    const sad = (data.sad * 100).toFixed(2);

    if (isNaN(happy) || isNaN(sad)) {
      console.warn('Computed NaN values, skipping table update:', { happy, sad });
      return;
    }

    tr.innerHTML = `<td>${now}</td><td>${happy}</td><td>${sad}</td>`;

    // choose blink color (green if happy > sad, else red)
    const blinkColor = sad > happy ? 'blink-red' : 'blink-green';
    tr.classList.add(blinkColor);
    if (tbody) tbody.prepend(tr);

    // make camera border blink too
    const video = document.getElementById('video');
    if (video) {
      video.classList.add(`border-${blinkColor}`);
      setTimeout(() => video.classList.remove(`border-${blinkColor}`), 800);
    }

    // remove table row blink after 2 seconds
    setTimeout(() => tr.classList.remove(blinkColor), 2000);

  } catch (err) {
    console.error('poll error', err);
  }
})();
</script>

<style>
@keyframes pulse-green {
  0%   { background-color: #b2ffb2; opacity: 0.9; }
  25%  { background-color: #d0ffd0; opacity: 1; }
  50%  { background-color: #e8ffe8; opacity: 0.8; }
  75%  { background-color: #c0ffc0; opacity: 1; }
  100% { background-color: transparent; opacity: 1; }
}

@keyframes pulse-red {
  0%   { background-color: #ffb2b2; opacity: 0.9; }
  25%  { background-color: #ffd0d0; opacity: 1; }
  50%  { background-color: #ffe8e8; opacity: 0.8; }
  75%  { background-color: #ffc0c0; opacity: 1; }
  100% { background-color: transparent; opacity: 1; }
}

.blink-green {
  animation: pulse-green 2s ease-in-out;
}

.blink-red {
  animation: pulse-red 2s ease-in-out;
}

.border-blink-green {
  border-color: #22c55e !important;
  transition: border-color 0.4s ease;
}

.border-blink-red {
  border-color: #ef4444 !important;
  transition: border-color 0.4s ease;
}
</style>
